<html>
    <head>
    <script src="md5.js"></script>
    <script src="utils.js"></script>
    <script src="audio_player.js"></script>
    <script src="oauth/chrome_ex_oauth.js"></script>
    <script src="scrobbler.js"></script>
    <script src="vk.js"></script>
    <script> 
    
    var repeat = false
    var stop_after_playing = false
    
    var audio_player = new HTML5AudioPlayer()    
    var scrobbler = new Scrobbler(window.localStorage["lastfm_session"], window.localStorage["lastfm_username"])
    
    chrome.browserAction.setBadgeBackgroundColor({color:[51,153,204,255]}) //blue
    
    var current_track
    var playlist = []

    audio_player.options.canPlayThrough = function(){
        console.log("Setting now playing:", current_track)

        scrobbler.setNowPlaying(current_track.artist, current_track.song, audio_player.audio.duration)
        chrome.browserAction.setTitle({title: current_track.track})
        
        current_track.port.postMessage({method:'readyToPlay', element_id: current_track.element_id})
        
        if(popup_port)
            popup_port.postMessage({method:'readyToPlay', index:current_track.index})
    }
    
    audio_player.options.onEnded = function(){
        if(audio_player.audio.duration != 30)
            scrobbler.scrobble(current_track.artist, current_track.song, audio_player.audio.duration)

        current_track.port.postMessage({method:'stop'})
        
        playNextTrack(repeat)
    }

    
    function playNextTrack(repeat){
        if(!current_track)
            return

        console.log("Playlist length:", playlist.length)
        console.log("Current track index:", current_track.index)
            
        if(repeat || !stop_after_playing && playlist.length > (current_track.index+1)){
            audio_player.pause()

            if(repeat){
                var next_track = current_track
            } else {
                var next_track = playlist[current_track.index+1]
                
                next_track.port   = current_track.port
                next_track.port_id = current_track.port_id
                next_track.song   = next_track.song.replace(/&amp;/g, '&')
                next_track.artist = next_track.artist.replace(/&amp;/g, '&')

                next_track.track  = next_track.artist + " - " + next_track.song
            }
            
            current_track.port.postMessage({method:'stop', element_id: current_track.element_id})
            if(popup_port)
                popup_port.postMessage({method:'stop', index: current_track.index})
                
            current_track = next_track
            
            current_track.port.postMessage({method:'loading', element_id: next_track.element_id})
            if(popup_port)
                current_track.port.postMessage({method:'loading', index: next_track.index})
            
            console.log("Playing next:", current_track)
            
            searchTrack(current_track)
        } else {
            current_track = null
        }
    }


    function updateTime(){
        if(!audio_player.audio.paused && audio_player.audio.duration){
            var time_left = audio_player.audio.duration - audio_player.audio.currentTime
            if(time_left != 0) {
                chrome.browserAction.setBadgeText({text:prettyTime(time_left)})
            } else
                chrome.browserAction.setBadgeText({text:''})

        }

        setTimeout(updateTime, 1000)
    }

    
    var not_found_in_row = 0
    
    function showNotification(){
        scrobbler.artistInfo(current_track.artist, function(response){
            var notification = window.webkitNotifications.createNotification(response.image, current_track.song, current_track.artist)

            notification.show()
            setTimeout(function(){notification.cancel()}, 5000)
        })
    }

    function searchTrack(track){
        VK.search(track.artist, track.song, function(response){
            if(response.error){
                if(response.error == 'not_found' && track.streamable) {
                    not_found_in_row = 0

                    scrobbler.preview_mp3(track.track_id, function(response){
                        audio_player.play(response.url)
                    })                
                    
                    showNotification()
                } else {
                    track.port.postMessage({method:'readyToPlay', error: response.error, element_id: track.element_id})
                    
                    if(popup_port)
                        track.port.postMessage({method:'readyToPlay', error: response.error, index: track.index})
                        
                    not_found_in_row += 1
                    if(not_found_in_row < 10)
                        setTimeout(playNextTrack, 500)
                }

            } else {
                not_found_in_row = 0
                audio_player.play(response.url)

                showNotification()
            }
        })
    }

    
    var popup_port
    
    function onLoad(){    
        updateTime()

        chrome.extension.onConnect.addListener(function(port) {    
            console.log("Connected:", port)
            
            if(port.name == "popup")
                popup_port = port

            port.onMessage.addListener(function(msg) {
                console.log(msg.method, msg)

                if(msg.method == "auth_token"){
                    scrobbler.getSession(msg.token, function(response){
                        console.log("Getting session:", response)

                        if(response.session){
                            window.localStorage['lastfm_session'] = response.session
                            window.localStorage['lastfm_username'] = response.username
                        }
                        
                        chrome.tabs.update(port.tab.id, {url:chrome.extension.getURL("options.html")})
                    })


                } else if(msg.method == "logout") {
                    scrobbler._username = null
                    scrobbler._session_key = null

                } else if(msg.method == "getTrackInfo"){                    
                    port.postMessage({
                        method: "trackInfo", 
                        track: current_track, 
                        paused:audio_player.audio.paused, 
                        playlist: playlist,
                        
                        stop_after_playing: stop_after_playing,
                        repeat: repeat,
                        scrobbling: scrobbler.scrobbling,
                        
                        username: scrobbler._username
                    })
                    
                } else if(msg.method == "scrobbling"){                
                    scrobbler.scrobbling = msg.state                    
                    
                } else if(msg.method == "repeat"){                
                    repeat = msg.state                    
                    
                } else if(msg.method == "stop_after_playing") {
                    stop_after_playing = msg.state
                    
                } else if(msg.method == "pause"){
                    audio_player.pause()                                    

                } else if(msg.method == "play"){
                    var track_info = msg.track

                    track_info.song = track_info.song.replace(/&amp;/g, '&')
                    track_info.artist =  track_info.artist.replace(/&amp;/g, '&')
                    
                    track_info.port = port

                    if(!msg.port_id)
                        track_info.port_id = port.tab ? port.portId_ : msg.track.port_id

                    track_info.track = track_info.artist + " - " + track_info.song

                    console.log("Track info:", track_info)
                    
                    if(msg.playlist)
                        playlist = msg.playlist                    

                    if(current_track && current_track.port_id == track_info.port_id && current_track.element_id == track_info.element_id){
                        audio_player.play()                       
                        
                        if(port.tab)
                            port.postMessage({method:'readyToPlay', element_id: current_track.element_id})
                        else
                            port.postMessage({method:'readyToPlay', index: current_track.index})
                        end
                    } else {                    

                        if(current_track && current_track.port_id && current_track.port_id != track_info.port_id)
                            current_track.port.postMessage({method:'stop'})

                        current_track = track_info

                        searchTrack(current_track)
                    }

                }
            })

            port.onDisconnect.addListener(function(msg){
                if(port.name == "popup")
                    delete popup_port
            })


            search_pattern = window.localStorage["search_pattern"]                            
            if(search_pattern == undefined)
                search_pattern = "http://vkontakte.ru/gsearch.php?section=audio&q=%s"
            
            if(!port.reconnect)
                port.postMessage({method:'setSearchPattern', search_pattern: search_pattern})
        })
    }
    </script>
    </head>
    <body onload="onLoad()">
    </body>
</html>

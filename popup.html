<html>
    <head>
    <link rel="stylesheet" href="css/mp3_player_button.css" type="text/css">
    <link rel="stylesheet" href="css/popup.css" type="text/css">

    <script src="javascript/utils.js"></script>
    <script src="javascript/scrobbler.js"></script>

    <script>
    var music_manager = chrome.extension.getBackgroundPage().music_manager

    music_manager.audio.addEventListener('onPlay', function(){
        stopCurrentTrack()

        if(music_manager.current_track != undefined)
            try{document.getElementById("ex_button_"+music_manager.current_track).className = "sm2_button playing"}catch(e){}
    }, true)

    music_manager.audio.addEventListener('onEnded', function(){
        stopCurrentTrack()
    }, true)

    music_manager.audio.addEventListener('onLoading', function(){
        if(music_manager.current_track != undefined)
            try{document.getElementById("ex_button_"+music_manager.current_track).className = "sm2_button loading"}catch(e){}
    }, true)

    function updatePlaylist(){
        var container = document.getElementById('tracks_container')        
        var html = ""
        var state
        
        var playlist = music_manager.playlist

        for(var i=0; i<playlist.length; i++){
            if(music_manager.current_track != undefined && music_manager.current_track == i)
                state = music_manager.audio.paused ? "paused" : "playing"
            else
                state = ""

            html += "<li>"+
                        "<span class='number'>"+(i+1)+"</span>"+
                        "<a id='ex_button_"+playlist[i].index+"' data-index-number='"+playlist[i].index+"' href='javascript:;' onclick='togglePlaying(this)' class='sm2_button "+state+"'></a>"+
                        "<span class='track'>"+
                            "<a target='_blank' href='http://last.fm/music/"+playlist[i].artist.replace(/\s/g,'+')+"'>"+playlist[i].artist + "</a>" + 
                            ' &ndash; '+ 
                            "<a target='_blank' href=\"http://last.fm/music/"+playlist[i].artist.replace(/\s/g,'+')+"/_/"+(playlist[i].song||"").replace(/\s/g,'+')+"\">"+playlist[i].song+"</a>"+
                        "</span>"+
                    "</li>" 
        }
        
        if(playlist.length == 0)
            html = "<li class='empty'>No tracks selected</li>"

        container.innerHTML = html
                
        if(music_manager.current_track != undefined && music_manager.current_track > 16)
            var playing_link = document.querySelector('a.playing, a.paused')
            
            if(playing_link)
                container.parentNode.scrollTop = playing_link.parentNode.offsetTop-55
    }
    
    function toggleRepeat(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = ''
        } else {
            link.className = 'active'
        }
        
        music_manager.repeat = link.className.match(/active/)
    }    
    
    
    function toggleStopAfterPlaying(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = ''
        } else {
            link.className = 'active'
        }

        music_manager.stop_after_playing = link.className.match(/active/)
    }

    function toggleScrobbling(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = ''
        } else {
            link.className = 'active'
        }

        music_manager.scrobbler.scrobbling = link.className.match(/active/)
    }   

    
    function onLoad(){
        updatePlaylist()

        if(music_manager.repeat)
            document.getElementById('repeat').className = 'active'

        if(music_manager.stop_after_playing)
            document.getElementById('stop_after_playing').className = 'active'
        
        if(music_manager.scrobbler.scrobbling)
            document.getElementById('scrobbling').className = 'active'

        if(!music_manager.scrobbler._username)
                document.getElementById('connect_lastfm').style.display = ''
            else
                document.getElementById('scrobbling').style.display = ''

        document.getElementById('repeat').addEventListener('click', toggleRepeat, false)
        document.getElementById('stop_after_playing').addEventListener('click', toggleStopAfterPlaying, false)
        document.getElementById('scrobbling').addEventListener('click', toggleScrobbling, false)
        document.getElementById('connect_lastfm').addEventListener('click', function(){new Scrobbler().auth()}, false)
    }

    function stopCurrentTrack(){
        var current_playing = document.querySelector("a.sm2_button.playing, a.sm2_button.paused, a.sm2_button.loading")

        if(current_playing)
            current_playing.className = "sm2_button"
    }    
    
    function togglePlaying(link){
        if(link.className.match(/disabled/))
            return false
    
        if(link.className.match('playing')){
            link.className = "sm2_button paused"

            music_manager.pause()
        } else {
            if(link.className.match(/paused/)){
                link.className = "sm2_button playing"
            } else {                
                stopCurrentTrack()

                link.className = "sm2_button loading"                        
            }
            
            music_manager.play(music_manager.playlist[link.getAttribute('data-index-number')])
        }
    }    

    </script>
    </head>    
    <body>
        <div id='repeat'>repeat</div>
        <div id='stop_after_playing'>stop after playing</div>
        <div id='scrobbling' style='display:none'>scrobbling</div>
        <a href="javascript:;" id='connect_lastfm' style="display:none">Want scrobbling?</a>

        <div class="wrapper">
            <ul style="white-space:nowrap" id="tracks_container">            
            </ul>
        </div>
        <script>
            onLoad()
        </script>
    </body>
</html>

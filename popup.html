<html>
    <head>
    <link rel="stylesheet" href="css/mp3_player_button.css" type="text/css">
    <link rel="stylesheet" href="css/popup.css" type="text/css">

    <script src="javascript/utils.js"></script>
    <script src="javascript/scrobbler.js"></script>

    <script>
    var port
    var current_track
    var playlist
    
    function updatePlaylist(){
        var container = document.getElementById('tracks_container')        
        var html = ""
        var state
        
        for(var i=0; i<playlist.length; i++){
            console.log("Item:", playlist[i])                                
        
            if(current_track && current_track.index == i)                
                state = current_track.paused ? "paused" : "playing"
            else
                state = ""
        
            html += "<li>"+
                        "<span class='number'>"+(i+1)+"</span>"+
                        "<a id='ex_button_"+playlist[i].index+"' data-index-number='"+playlist[i].index+"' href='javascript:;' onclick='togglePlaying(this)' class='sm2_button "+state+"'></a>"+
                        "<span class='track'>"+
                            "<a target='_blank' href='http://last.fm/music/"+playlist[i].artist.replace(/\s/g,'+')+"'>"+playlist[i].artist + "</a>" + 
                            ' &ndash; '+ 
                            "<a target='_blank' href=\"http://last.fm/music/"+playlist[i].artist.replace(/\s/g,'+')+"/_/"+playlist[i].song.replace(/\s/g,'+')+"\">"+playlist[i].song+"</a>"+
                        "</span>"+
                    "</li>" 
        }
        
        if(playlist.length == 0)
            html = "<li class='empty'>No tracks selected</li>"

        container.innerHTML = html
                
        if(current_track && current_track.index > 16)
            container.parentNode.scrollTop = document.querySelector('a.playing').parentNode.offsetTop-30
    }
    
    function initializePort(){
        port = chrome.extension.connect({name: "popup"})
        
        port.onMessage.addListener(function(msg){
            console.log("Message:", msg)

            if(msg.method == 'trackInfo'){
                console.log("Track info:", msg)
            
                playlist = msg.playlist
                current_track = msg.track
                
                if(current_track)
                    current_track.paused = msg.paused
                
                if(msg.repeat)
                    document.getElementById('repeat').className = "active"
                    
                if(msg.stop_after_playing)
                    document.getElementById('stop_after_playing').className = "active"

                if(msg.scrobbling)
                    document.getElementById('scrobbling').className = "active"
                
                console.log("Current track:", current_track)
                
                if(msg.playlist)
                    updatePlaylist()
                
                if(!msg.username)
                    document.getElementById('connect_lastfm').style.display = ''
                else
                    document.getElementById('scrobbling').style.display = ''
                    
            } else if(msg.method == 'readyToPlay'){
                stopCurrentTrack()

                var button = document.getElementById("ex_button_"+msg.index)

                if(msg.error){
                    button.className = "sm2_button disabled"
                    button.title = msg.error
                } else {
                    button.className = "sm2_button playing"
                }                

                current_track = playlist[msg.index]                

                console.log(current_track)
            } else if(msg.method == "stop") {
                stopCurrentTrack()

            } else if(msg.method == "loading") {
                var button = document.getElementById("ex_button_"+msg.index)
                button.className = "sm2_button loading"                
            }
        })
    }

    function toggleRepeat(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = ''
        } else {
            link.className = 'active'
        }
        
        port.postMessage({method:'repeat', state:link.className.match(/active/)})
    }    
    
    
    function toggleStopAfterPlaying(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = ''
        } else {
            link.className = 'active'
        }

        port.postMessage({method:'stop_after_playing', state:link.className.match(/active/)})
    }

    function toggleScrobbling(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = ''
        } else {
            link.className = 'active'
        }

        port.postMessage({method:'scrobbling', state:link.className.match(/active/)})
    }   

    
    function onLoad(){
        initializePort()
        port.postMessage({method:'getTrackInfo'})

        document.getElementById('repeat').addEventListener('click', toggleRepeat, false)
        document.getElementById('stop_after_playing').addEventListener('click', toggleStopAfterPlaying, false)
        document.getElementById('scrobbling').addEventListener('click', toggleScrobbling, false)
        document.getElementById('connect_lastfm').addEventListener('click', function(){new Scrobbler().auth()}, false)
    }

    function stopCurrentTrack(){
        var current_playing = document.querySelector("a.sm2_button.playing, a.sm2_button.paused, a.sm2_button.loading")

        if(current_playing)
            current_playing.className = "sm2_button"
    }    
    
    function togglePlaying(link){
        if(link.className.match(/disabled/))
            return false
    
        if(link.className.match('playing')){
            port.postMessage({method: 'pause'})
            link.className = "sm2_button paused"
        } else {        
            if(link.className.match(/paused/)){
                port.postMessage({method: 'play', track: current_track})
                link.className = "sm2_button playing"
            } else {
                stopCurrentTrack()
            
                link.className = "sm2_button loading"                        
                port.postMessage({method: 'play', track: playlist[parseInt(link.getAttribute('data-index-number'))]})
            }
        }
    }    

    </script>
    </head>    
    <body onload="onLoad()">
        <div id='repeat'>repeat</div>
        <div id='stop_after_playing'>stop after playing</div>
        <div id='scrobbling' style='display:none'>scrobbling</div>
        <a href="javascript:;" id='connect_lastfm' style="display:none">Want scrobbling?</a>

        <div class="wrapper" style="">
            <ul style="white-space:nowrap" id="tracks_container">            
            </ul>
        </div>
    </body>
</html>
